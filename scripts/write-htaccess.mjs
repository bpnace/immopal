import { mkdirSync, writeFileSync } from 'node:fs';
import { join } from 'node:path';
import { chmodSync, readdirSync, statSync, unlinkSync } from 'node:fs';

const outDir = join(process.cwd(), 'out');
mkdirSync(outDir, { recursive: true });
const htaccessPath = join(outDir, '.htaccess');
const generateHtaccessEnv = process.env.GENERATE_HTACCESS?.trim().toLowerCase();
const shouldGenerateHtaccess = !(generateHtaccessEnv === '0' || generateHtaccessEnv === 'false' || generateHtaccessEnv === 'no');

function normalizePermissions(dir) {
  const entries = readdirSync(dir, { withFileTypes: true });
  for (const entry of entries) {
    const fullPath = join(dir, entry.name);
    if (entry.isDirectory()) {
      chmodSync(fullPath, 0o755);
      normalizePermissions(fullPath);
      continue;
    }
    if (entry.isFile()) {
      // Remove macOS metadata files from deploy output.
      if (entry.name === '.DS_Store') {
        try {
          unlinkSync(fullPath);
        } catch {
          // ignore
        }
        continue;
      }
      chmodSync(fullPath, 0o644);
      continue;
    }
    // Best effort for other types (symlinks, etc.)
    try {
      const s = statSync(fullPath);
      if (s.isFile()) chmodSync(fullPath, 0o644);
      if (s.isDirectory()) chmodSync(fullPath, 0o755);
    } catch {
      // ignore
    }
  }
}

const htaccess = `# Generated by scripts/write-htaccess.mjs
# Static export deployment (IONOS/Apache)

DirectoryIndex index.html
ErrorDocument 404 /404.html

RewriteEngine On
RewriteBase /

# Enforce HTTPS and canonical host
RewriteCond %{HTTPS} !=on [OR]
RewriteCond %{HTTP_HOST} !^www\\.immo-pal\\.de$ [NC]
RewriteRule ^(.*)$ https://www.immo-pal.de/$1 [R=301,L]

# Redirect legacy URLs
RewriteRule ^immobilien/?$ /angebote/ [R=301,L]
RewriteRule ^immobilien/([^/]+)/?$ /angebote/?slug=$1 [R=301,L,QSA]

# Basic caching for static assets
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType image/jpg "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType text/css "access plus 1 month"
  ExpiresByType application/javascript "access plus 1 month"
  ExpiresByType text/javascript "access plus 1 month"
</IfModule>
`;

if (shouldGenerateHtaccess) {
  writeFileSync(htaccessPath, htaccess, 'utf8');
  chmodSync(htaccessPath, 0o644);
  console.log('Wrote out/.htaccess');
} else {
  try {
    unlinkSync(htaccessPath);
    console.log('Removed out/.htaccess (GENERATE_HTACCESS disabled)');
  } catch {
    // ignore if file does not exist
  }
  console.log('Skipped out/.htaccess generation (GENERATE_HTACCESS disabled)');
}

// Ensure Apache can read all exported files (important for webspace deployments).
chmodSync(outDir, 0o755);
normalizePermissions(outDir);
